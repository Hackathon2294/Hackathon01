<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการข้อมูลน้ำบาดาล - หน้าช่วยสร้างข้อมูล</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="bg-blue-600 text-white p-4 rounded-lg shadow-md mb-6">
            <h1 class="text-2xl font-bold">จัดการข้อมูลน้ำบาดาล - เครื่องมือช่วยสร้างข้อมูล</h1>
            <p class="text-sm">ช่วยสร้างข้อมูลสำหรับนำไปใส่ใน Google Sheet ของคุณ</p>
        </header>

        <main class="bg-white rounded-lg shadow-md p-6">
            <!-- Google Sheet Helper -->
            <section class="mb-6">
                <div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 mb-4">
                    <h3 class="font-semibold text-yellow-800">วิธีการใช้งาน</h3>
                    <p class="text-sm text-yellow-700 mt-1">
                        1. เลือกรูปแบบข้อมูลที่ต้องการสร้าง (บ่อบาดาลหรือข้อมูลทั่วไป)<br>
                        2. กรอกข้อมูลในฟอร์มด้านล่าง<br>
                        3. กดปุ่ม "สร้างข้อมูลสำหรับ Google Sheet"<br>
                        4. คัดลอกข้อมูลที่สร้างขึ้น<br>
                        5. นำไปวางในไฟล์ Google Sheet ของคุณ<br>
                    </p>
                </div>
                
                <!-- Data Format Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">เลือกรูปแบบข้อมูล</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="dataFormat" value="borehole" checked class="form-radio text-blue-600" onchange="toggleDataFormat('borehole')">
                            <span class="ml-2">ข้อมูลบ่อบาดาล (มีพิกัดจริง)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="dataFormat" value="location" class="form-radio text-green-600" onchange="toggleDataFormat('location')">
                            <span class="ml-2">ข้อมูลทั่วไป (สร้างพิกัดอัตโนมัติ)</span>
                        </label>
                    </div>
                </div>
                
                    <div class="flex space-x-2">
                        <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vSn30i6fduRSszPNUwWskmwK8-KKunVtFfqGAyyFBAzXWJx5C0uz_6iLhai-F2rdwFOxlGMNdEU2uT_/edit" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-medium py-1 px-3 rounded text-sm">
                            ไปที่ Google Sheet ของคุณ
                        </a>
                        <a href="index.html" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-3 rounded text-sm">
                            กลับไปหน้าแผนที่
                        </a>
                    </div>
            </section>

            <!-- Data Format Selector -->
            <section class="mb-6 border-t pt-4">
                <h2 class="text-xl font-semibold mb-4">เลือกรูปแบบข้อมูล</h2>
                <div class="flex gap-3">
                    <button id="selectBoreholeFormat" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-medium flex-1">
                        ข้อมูลบ่อบาดาล
                    </button>
                    <button id="selectLocationFormat" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 font-medium flex-1">
                        ข้อมูลทั่วไป (แบบตารางงาน)
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    <span class="font-semibold">ข้อมูลบ่อบาดาล:</span> สำหรับข้อมูลที่มีพิกัด, รหัสบ่อ, ความลึก และชั้นดิน<br>
                    <span class="font-semibold">ข้อมูลทั่วไป:</span> สำหรับตารางงานที่มี ชื่องาน, ระดับความสำคัญ, เจ้าของ, สถานะ ฯลฯ
                </p>
            </section>

            <!-- Data Output Section -->
            <section class="mb-6 border-t pt-4">
                <h2 class="text-xl font-semibold mb-2">ข้อมูลสำหรับ Google Sheet</h2>
                <div class="space-y-4">
                    <!-- เพิ่มช่องสำหรับใส่ URL ของ Google Sheet CSV -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded mb-4">
                        <label for="sheetUrl" class="block text-sm font-medium text-blue-800 mb-1">URL ของ Google Sheet CSV หลัก (ข้อมูลพื้นฐาน)</label>
                        <div class="flex">
                            <input type="text" id="sheetUrl" class="flex-grow p-2 border rounded text-sm" 
                                placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=0">
                            <button id="saveSheetUrl" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                บันทึก URL
                            </button>
                        </div>
                        <p class="text-xs text-blue-600 mt-1">
                            URL นี้จะใช้สำหรับข้อมูลพื้นฐาน (ละติจูด, ลองจิจูด, รายละเอียด, ความลึก, ระดับน้ำ)
                        </p>
                    </div>
                    
                    <div class="p-3 bg-green-50 border border-green-200 rounded">
                        <label for="soilSheetUrl" class="block text-sm font-medium text-green-800 mb-1">URL ของ Google Sheet CSV ชั้นดิน (ไม่จำเป็น)</label>
                        <div class="flex">
                            <input type="text" id="soilSheetUrl" class="flex-grow p-2 border rounded text-sm" 
                                placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=1">
                            <button id="saveSoilSheetUrl" class="ml-2 bg-green-500 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                บันทึก URL
                            </button>
                        </div>
                        <p class="text-xs text-green-600 mt-1">
                            URL นี้จะใช้สำหรับข้อมูลชั้นดิน (ชื่อดิน, ช่วงความลึก, รายละเอียด, สี, pH)
                        </p>
                    </div>
                    
                    <!-- ช่องแสดงข้อมูล CSV ที่สร้างขึ้น -->
                    <div class="p-3 bg-gray-50 border rounded">
                        <label for="generatedData" class="block text-sm font-medium text-gray-700 mb-1">ข้อมูลที่สร้างขึ้น (สำหรับคัดลอกไปที่ Google Sheet)</label>
                        <textarea id="generatedData" rows="4" class="w-full p-2 border rounded text-sm font-mono" readonly placeholder="ข้อมูลที่สร้างขึ้นจะแสดงที่นี่..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button id="generateCSV" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            สร้างข้อมูลสำหรับ Google Sheet
                        </button>
                        <button id="copyCSV" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            คัดลอกข้อมูล
                        </button>
                        <button id="copyAndOpenSheet" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                            คัดลอก + เปิด Google Sheet
                        </button>
                        <button id="clearForm" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                            ล้างฟอร์ม
                        </button>
                    </div>
                </div>
            </section>

            <!-- Form for adding new groundwater point -->
            <form id="groundwaterForm" class="border-t pt-4">
                <h2 class="text-xl font-semibold mb-4">เพิ่มจุดน้ำบาดาลใหม่</h2>
                
                <!-- Location details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="latitude" class="block text-sm font-medium text-gray-700">ละติจูด</label>
                        <input type="number" step="0.0000001" id="latitude" name="latitude" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="longitude" class="block text-sm font-medium text-gray-700">ลองจิจูด</label>
                        <input type="number" step="0.0000001" id="longitude" name="longitude" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="boreholeId" class="block text-sm font-medium text-gray-700">รหัสบ่อ</label>
                        <div class="flex space-x-2">
                            <div class="w-1/3">
                                <select id="boreholeSeries" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                    <option value="SRN">SRN</option>
                                    <option value="NKT">NKT</option>
                                    <option value="PCB">PCB</option>
                                    <option value="CMI">CMI</option>
                                    <option value="KKN">KKN</option>
                                    <option value="custom">อื่นๆ...</option>
                                </select>
                            </div>
                            <div class="w-2/3">
                                <div class="flex items-center">
                                    <span id="boreholePrefix" class="mr-1 text-gray-500">SRN-</span>
                                    <input type="text" id="boreholeNumber" 
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                        placeholder="1027">
                                </div>
                                <input type="hidden" id="boreholeId" name="boreholeId" required>
                            </div>
                        </div>
                        <div class="mt-1">
                            <button type="button" id="checkBoreholeButton" class="text-sm text-blue-600 hover:text-blue-800">
                                ตรวจสอบรหัสที่มีอยู่แล้ว
                            </button>
                        </div>
                        <div id="existingBoreholeContainer" class="mt-2 hidden">
                            <div class="bg-gray-50 rounded p-2 max-h-28 overflow-y-auto">
                                <p class="text-sm font-medium mb-1">รหัสบ่อที่มีอยู่แล้ว:</p>
                                <div id="existingBoreholes" class="text-xs grid grid-cols-3 gap-1"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="totalDepth" class="block text-sm font-medium text-gray-700">ความลึกทั้งหมด (เมตร)</label>
                        <input type="number" step="0.1" id="totalDepth" name="totalDepth" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="waterLevel" class="block text-sm font-medium text-gray-700">ระดับน้ำบาดาล (เมตร)</label>
                        <input type="number" step="0.1" id="waterLevel" name="waterLevel" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>
                
                <!-- Soil Layers -->
                <div class="border rounded-md p-4 mb-6">
                    <h3 class="font-semibold mb-2">ข้อมูลชั้นดิน</h3>
                    <div id="soilLayers">
                        <!-- Soil Layer 1 -->
                        <div class="soil-layer border-b pb-4 mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">ชั้นที่ 1</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ชื่อชั้นดิน</label>
                                    <input type="text" name="soilName1" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                        placeholder="ดินเหนียว">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ช่วงความลึก</label>
                                    <input type="text" name="soilDepth1" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                        placeholder="0-8 ม.">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                                    <input type="text" name="soilDesc1"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                        placeholder="ดินเหนียวสีน้ำตาลแดง">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">สี (hex หรือชื่อสี)</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="color" name="soilColorPicker1" value="#D2B48C" 
                                            class="h-10 w-12 rounded-md border-gray-300 shadow-sm">
                                        <input type="text" name="soilColor1" value="#D2B48C" required
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ค่า pH</label>
                                    <input type="number" step="0.1" name="soilPH1" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                        placeholder="7.0">
                                </div>
                            </div>
                        </div>

                        <!-- Template for additional layers will be added via JavaScript -->
                    </div>
                    
                    <button type="button" id="addLayer" class="mt-2 bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">
                        + เพิ่มชั้นดิน
                    </button>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="reset" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        ล้างข้อมูล
                    </button>
                </div>
            </form>

            <!-- Form for general location data (hidden by default) -->
            <form id="locationForm" class="border-t pt-4 hidden">
                <h2 class="text-xl font-semibold mb-4">เพิ่มข้อมูลทั่วไป (ตารางงาน)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="taskName" class="block text-sm font-medium text-gray-700">งาน</label>
                        <input type="text" id="taskName" name="taskName" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700">ระดับความสำคัญ</label>
                        <select id="priority" name="priority" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="P0">P0</option>
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="owner" class="block text-sm font-medium text-gray-700">เจ้าของ</label>
                        <input type="text" id="owner" name="owner" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="taskStatus" class="block text-sm font-medium text-gray-700">สถานะ</label>
                        <select id="taskStatus" name="taskStatus" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="ยังไม่เริ่ม">ยังไม่เริ่ม</option>
                            <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                            <option value="ถูกยกเลิก">ถูกยกเลิก</option>
                            <option value="เสร็จสมบูรณ์">เสร็จสมบูรณ์</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label>
                        <input type="date" id="startDate" name="startDate"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                        <input type="date" id="endDate" name="endDate"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 mb-4">
                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-700">เหตุผลสำคัญ</label>
                        <textarea id="reason" name="reason" rows="2"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 mb-4">
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">โน้ต</label>
                        <textarea id="notes" name="notes"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="reset" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        ล้างข้อมูล
                    </button>
                </div>
            </form>

            <!-- Data Format Explanation -->
            <section id="dataFormatExplanation" class="mb-6 border-t pt-4 hidden">
                <h2 class="text-xl font-semibold mb-2">คำอธิบายรูปแบบข้อมูล</h2>
                <div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <p class="text-sm text-blue-700">
                        รูปแบบข้อมูลที่ 1 (ข้อมูลบ่อบาดาล): ใช้สำหรับกรอกข้อมูลบ่อบาดาลที่มีพิกัดจริง<br>
                        รูปแบบข้อมูลที่ 2 (ข้อมูลทั่วไป): ใช้สำหรับกรอกข้อมูลทั่วไป โดยระบบจะสร้างพิกัดอัตโนมัติ
                    </p>
                </div>
            </section>

            <!-- Direct Paste Section -->
            <section class="mb-6 border-t pt-4">
                <h2 class="text-xl font-semibold mb-2">วางข้อมูลลง Google Sheet โดยตรง</h2>
                <div class="space-y-4">
                    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-600 rounded-r">
                        <p class="font-medium">วิธีเพิ่มข้อมูลลง Google Sheet โดยตรง:</p>
                        <ol class="list-decimal list-inside text-sm pl-2 mt-2">
                            <li>กรอกข้อมูลในฟอร์มด้านบนให้ครบถ้วน</li>
                            <li>คลิกปุ่ม "สร้างข้อมูลสำหรับ Google Sheet"</li>
                            <li>คลิกปุ่ม "คัดลอกและเปิด Google Sheet"</li>
                            <li>ไปยังแถวใหม่ในชีท คลิกขวา และเลือก "Paste" หรือกด Ctrl+V (หรือ Command+V บน Mac)</li>
                        </ol>
                    </div>
                    
                    <button id="copyAndOpenSheet" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full flex items-center justify-center">
                        <span class="mr-2">คัดลอกและเปิด Google Sheet</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </button>
                </div>
            </section>

            <!-- ขั้นตอนการใส่ข้อมูลจริงใน Google Sheet -->
            <div class="p-4 bg-green-50 border-l-4 border-green-500 mb-4">
                <h3 class="font-semibold text-green-800">ขั้นตอนการใส่ข้อมูลจริงใน Google Sheet</h3>
                <ol class="text-sm text-green-700 mt-2 space-y-1">
                    <li><strong>ขั้นตอนที่ 1:</strong> กรอกข้อมูลจริงในฟอร์มด้านล่าง (แทนข้อมูลตัวอย่าง)</li>
                    <li><strong>ขั้นตอนที่ 2:</strong> กดปุ่ม "สร้างข้อมูลสำหรับ Google Sheet"</li>
                    <li><strong>ขั้นตอนที่ 3:</strong> กดปุ่ม "คัดลอกข้อมูล" หรือ "คัดลอกและเปิด Google Sheet"</li>
                    <li><strong>ขั้นตอนที่ 4:</strong> ไปที่ Google Sheet แล้ววางข้อมูล (Ctrl+V หรือ Cmd+V) ในแถวว่าง</li>
                    <li><strong>ขั้นตอนที่ 5:</strong> กลับมาที่ index.html เพื่อดูข้อมูลบนแผนที่</li>
                </ol>
                <div class="mt-3 p-2 bg-green-100 rounded text-xs">
                    <strong>💡 เคล็ดลับ:</strong> หากใส่ข้อมูลหลายแถว แนะนำให้สร้างทีละแถวแล้ววางใน Google Sheet ทีละครั้ง
                </div>
            </div>
        </main>

        <footer class="mt-6 text-center text-sm text-gray-600">
            <p>© 2025 ระบบจัดการข้อมูลน้ำบาดาล</p>
        </footer>
    </div>

    <script>
        // Global variables
        let currentDataFormat = 'borehole';
        let layerCount = 1;
        
        // Format a value for CSV, adding quotes if needed
        function formatForCSV(value) {
            if (value === null || value === undefined) {
                return '';
            }
            
            const stringValue = String(value);
            // If value contains comma, newline, or quotes, wrap in quotes and escape any quotes
            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        }
        
        // Add a new soil layer
        function addSoilLayer() {
            layerCount++;
            const layersContainer = document.getElementById('soilLayers');
            
            const newLayer = document.createElement('div');
            newLayer.className = 'soil-layer border-b pb-4 mb-4';
            newLayer.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium">ชั้นที่ ${layerCount}</h4>
                    <button type="button" class="remove-layer text-red-500 hover:text-red-700">
                        ลบชั้นนี้
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ชื่อชั้นดิน</label>
                        <input type="text" name="soilName${layerCount}" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ช่วงความลึก</label>
                        <input type="text" name="soilDepth${layerCount}" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                        <input type="text" name="soilDesc${layerCount}"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">สี (hex หรือชื่อสี)</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" name="soilColorPicker${layerCount}" value="#CCCCCC" 
                                class="h-10 w-12 rounded-md border-gray-300 shadow-sm">
                            <input type="text" name="soilColor${layerCount}" value="#CCCCCC" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ค่า pH</label>
                        <input type="number" step="0.1" name="soilPH${layerCount}" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                </div>
            `;
            
            layersContainer.appendChild(newLayer);
            
            // Add event listener to remove button
            newLayer.querySelector('.remove-layer').addEventListener('click', function() {
                newLayer.remove();
                // Renumber the layers
                document.querySelectorAll('.soil-layer').forEach((layer, index) => {
                    layer.querySelector('h4').textContent = `ชั้นที่ ${index + 1}`;
                });
            });
            
            // Sync color picker with text input
            const colorPicker = newLayer.querySelector(`input[name="soilColorPicker${layerCount}"]`);
            const colorText = newLayer.querySelector(`input[name="soilColor${layerCount}"]`);
            
            colorPicker.addEventListener('input', () => {
                colorText.value = colorPicker.value;
            });
            
            colorText.addEventListener('input', () => {
                // Only update if it's a valid color format
                if (/^#[0-9A-F]{6}$/i.test(colorText.value)) {
                    colorPicker.value = colorText.value;
                }
            });
        }

        // Toggle between data formats
        function toggleDataFormat(format) {
            currentDataFormat = format;
            if (format === 'borehole') {
                document.getElementById('groundwaterForm').classList.remove('hidden');
                document.getElementById('locationForm').classList.add('hidden');
            } else {
                document.getElementById('groundwaterForm').classList.add('hidden');
                document.getElementById('locationForm').classList.remove('hidden');
            }
        }

        // Generate CSV data from form
        function generateCSV() {
            if (currentDataFormat === 'borehole') {
                return generateBoreholeCSV();
            } else {
                return generateLocationCSV();
            }
        }
        
        // Generate CSV for borehole data
        function generateBoreholeCSV() {
            // Collect form data
            const form = document.getElementById('groundwaterForm');
            const formData = new FormData(form);
            const layerCount = document.querySelectorAll('#groundwaterForm .soil-layer').length;
            
            // Basic validation
            const latitude = formData.get('latitude');
            const longitude = formData.get('longitude');
            const boreholeId = formData.get('boreholeId');
            
            if (!latitude || !longitude || !boreholeId) {
                alert('กรุณากรอกข้อมูลพื้นฐาน (ละติจูด, ลองจิจูด, รหัสบ่อ) ให้ครบถ้วน');
                return false;
            }
            
            // Prepare row for Google Sheets
            let rowData = [
                formData.get('latitude'),
                formData.get('longitude'),
                formData.get('boreholeId'),
                formData.get('totalDepth'),
                formData.get('waterLevel')
            ];
            
            // Add soil layer data
            for (let i = 1; i <= 4; i++) {
                if (i <= layerCount) {
                    rowData.push(
                        formData.get(`soilName${i}`) || '',
                        formData.get(`soilDepth${i}`) || '',
                        formData.get(`soilDesc${i}`) || '',
                        formData.get(`soilColor${i}`) || '',
                        formData.get(`soilPH${i}`) || ''
                    );
                } else {
                    // Add empty values for unused layers
                    rowData.push('', '', '', '', '');
                }
            }
            
            // Format as CSV row
            const csvRow = rowData.map(formatForCSV).join(',');
            document.getElementById('generatedData').value = csvRow;
            
            return true;
        }
        
        // Generate CSV for location data (task format)
        function generateLocationCSV() {
            // Collect form data
            const form = document.getElementById('locationForm');
            const formData = new FormData(form);
            
            // Basic validation
            const taskName = formData.get('taskName');
            
            if (!taskName) {
                alert('กรุณากรอกชื่องาน');
                return false;
            }
            
            // Prepare row for Google Sheets
            let rowData = [
                formData.get('taskName'), // งาน (A)
                formData.get('priority') || 'P3', // ระดับความสำคัญ (B)
                formData.get('owner') || '', // เจ้าของ (C)
                formData.get('taskStatus') || 'ยังไม่เริ่ม', // สถานะ (D)
                formData.get('startDate') || '', // วันที่เริ่มต้น (E)
                formData.get('endDate') || '', // วันที่สิ้นสุด (F)
                formData.get('reason') || '', // เหตุผลสำคัญ (G)
                '', // File placeholder (H)
                formData.get('notes') || '' // โน้ต (I)
            ];
            
            // Format as CSV row
            const csvRow = rowData.map(formatForCSV).join(',');
            document.getElementById('generatedData').value = csvRow;
            
            return true;
        }
        
        // Copy CSV data to clipboard
        function copyCSV() {
            const textarea = document.getElementById('generatedData');
            if (!textarea.value) {
                alert('กรุณาสร้างข้อมูลก่อนทำการคัดลอก');
                return;
            }
            
            textarea.select();
            document.execCommand('copy');
            
            alert('คัดลอกข้อมูลเรียบร้อยแล้ว คุณสามารถนำไปวางใน Google Sheet ได้เลย');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addLayer').addEventListener('click', addSoilLayer);
            document.getElementById('generateCSV').addEventListener('click', generateCSV);
            document.getElementById('copyCSV').addEventListener('click', copyCSV);
            
            // ปุ่มเลือกรูปแบบข้อมูล
            document.getElementById('selectBoreholeFormat').addEventListener('click', function() {
                toggleDataFormat('borehole');
                this.classList.remove('bg-gray-200', 'text-gray-800');
                this.classList.add('bg-blue-500', 'text-white');
                document.getElementById('selectLocationFormat').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('selectLocationFormat').classList.add('bg-gray-200', 'text-gray-800');
            });
            
            document.getElementById('selectLocationFormat').addEventListener('click', function() {
                toggleDataFormat('location');
                this.classList.remove('bg-gray-200', 'text-gray-800');
                this.classList.add('bg-blue-500', 'text-white');
                document.getElementById('selectBoreholeFormat').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('selectBoreholeFormat').classList.add('bg-gray-200', 'text-gray-800');
            });
            
            // ฟังก์ชันสำหรับคัดลอกข้อมูลและเปิด Google Sheet
            document.getElementById('copyAndOpenSheet').addEventListener('click', function() {
                const textarea = document.getElementById('generatedData');
                if (!textarea.value) {
                    alert('กรุณาสร้างข้อมูลก่อนโดยกดปุ่ม "สร้างข้อมูลสำหรับ Google Sheet"');
                    return;
                }
                
                // คัดลอกข้อมูล
                textarea.select();
                document.execCommand('copy');
                
                // เปิด Google Sheet ในแท็บใหม่
                window.open('https://docs.google.com/spreadsheets/d/1rHFWxtgQ47Npi9rMDoYjvXAzpr5F8jfu4L3RTa09a1Q/edit', '_blank');
                
                alert('คัดลอกข้อมูลเรียบร้อยแล้ว Google Sheet กำลังเปิดในแท็บใหม่\nกรุณาไปที่แถวว่างและวางข้อมูล (Ctrl+V หรือ Command+V)');
            });
            
            // ฟังก์ชันสำหรับตรวจสอบรหัสบ่อที่มีอยู่แล้ว
            async function checkExistingBoreholes() {
                const csvUrl = document.getElementById('generatedData').getAttribute('data-sheet-url') || '';
                const container = document.getElementById('existingBoreholeContainer');
                const boreholesList = document.getElementById('existingBoreholes');
                
                // ถ้าไม่มี URL กำหนดไว้ ให้แสดงรหัสตัวอย่างแทน
                if (!csvUrl) {
                    boreholesList.innerHTML = '';
                    
                    // รหัสบ่อตัวอย่าง
                    const exampleBoreholes = [
                        'SRN-1001', 'SRN-1002', 'SRN-1027', 'SRN-1245', 
                        'NKT-0352', 'NKT-0353', 'NKT-0401',
                        'PCB-0012', 'PCB-0045', 'CMI-5501', 'KKN-1122'
                    ];
                    
                    exampleBoreholes.forEach(id => {
                        const span = document.createElement('span');
                        span.className = 'px-1 py-0.5 bg-gray-200 rounded text-gray-700';
                        span.textContent = id;
                        span.addEventListener('click', () => {
                            // แยกรหัสบ่อเป็นซีรีส์และตัวเลข
                            const parts = id.split('-');
                            if (parts.length === 2) {
                                if (boreholeSeries.querySelector(`option[value="${parts[0]}"]`)) {
                                    boreholeSeries.value = parts[0];
                                    boreholePrefix.textContent = `${parts[0]}-`;
                                } else {
                                    boreholeSeries.value = 'custom';
                                    boreholePrefix.textContent = '';
                                }
                                boreholeNumber.value = parts[1];
                                updateBoreholeId();
                            }
                        });
                        boreholesList.appendChild(span);
                        
                        // เพิ่มช่องว่างระหว่างแท็ก
                        boreholesList.appendChild(document.createTextNode(' '));
                    });
                    
                    container.classList.remove('hidden');
                    return;
                }
                
                // แสดง Loading
                boreholesList.innerHTML = '<div class="col-span-3 text-center">กำลังโหลดข้อมูล...</div>';
                container.classList.remove('hidden');
                
                try {
                    // ดึงข้อมูลจาก Google Sheet CSV
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error('ไม่สามารถโหลดข้อมูลได้');
                    }
                    
                    const text = await response.text();
                    const rows = text.split('\n');
                    
                    // เก็บรหัสบ่อที่พบ (คอลัมน์ที่ 3 ของ CSV)
                    const boreholeIds = [];
                    rows.forEach((row, index) => {
                        if (index === 0) return; // ข้ามหัวตาราง
                        
                        const columns = row.split(',');
                        if (columns.length >= 3 && columns[2]) {
                            const id = columns[2].trim().replace(/^"|"$/g, ''); // ลบ quotes ถ้ามี
                            if (id) boreholeIds.push(id);
                        }
                    });
                    
                    // แสดงรหัสบ่อที่พบ
                    boreholesList.innerHTML = '';
                    if (boreholeIds.length === 0) {
                        boreholesList.innerHTML = '<div class="col-span-3">ไม่พบข้อมูลรหัสบ่อ</div>';
                    } else {
                        boreholeIds.forEach(id => {
                            const span = document.createElement('span');
                            span.className = 'px-1 py-0.5 bg-gray-200 rounded text-gray-700';
                            span.textContent = id;
                            span.addEventListener('click', () => {
                                // แยกรหัสบ่อเป็นซีรีส์และตัวเลข
                                const parts = id.split('-');
                                if (parts.length === 2) {
                                    if (boreholeSeries.querySelector(`option[value="${parts[0]}"]`)) {
                                        boreholeSeries.value = parts[0];
                                        boreholePrefix.textContent = `${parts[0]}-`;
                                    } else {
                                        boreholeSeries.value = 'custom';
                                        boreholePrefix.textContent = '';
                                    }
                                    boreholeNumber.value = parts[1];
                                    updateBoreholeId();
                                }
                            });
                            boreholesList.appendChild(span);
                            
                            // เพิ่มช่องว่างระหว่างแท็ก
                            boreholesList.appendChild(document.createTextNode(' '));
                        });
                    }
                } catch (error) {
                    console.error('Error fetching boreholes:', error);
                    boreholesList.innerHTML = '<div class="col-span-3">ไม่สามารถโหลดข้อมูลได้</div>';
                }
            }
            
            document.querySelector('input[name="soilName1"]').value = 'ดินเหนียว';
            document.querySelector('input[name="soilDepth1"]').value = '0-8 ม.';
            document.querySelector('input[name="soilDesc1"]').value = 'ดินเหนียวสีน้ำตาลแดง';
            document.querySelector('input[name="soilPH1"]').value = '6.5';
            
            // ตั้งค่าตัวอย่างข้อมูลสำหรับฟอร์มตารางงาน
            if (document.querySelector('#taskName')) {
                document.querySelector('#taskName').value = 'ตรวจสอบคุณภาพน้ำประจำเดือน';
                document.querySelector('#priority').value = 'P2';
                document.querySelector('#owner').value = 'ทีมคุณภาพน้ำ';
                document.querySelector('#taskStatus').value = 'กำลังดำเนินการ';
                
                // ตั้งค่าวันที่เป็นวันปัจจุบันและวันถัดไป 30 วัน
                const today = new Date();
                const thirtyDaysLater = new Date();
                thirtyDaysLater.setDate(today.getDate() + 30);
                
                // Format dates as YYYY-MM-DD
                document.querySelector('#startDate').value = today.toISOString().split('T')[0];
                document.querySelector('#endDate').value = thirtyDaysLater.toISOString().split('T')[0];
                
                document.querySelector('#reason').value = 'เพื่อการประเมินคุณภาพน้ำตามมาตรฐาน';
                document.querySelector('#notes').value = 'พื้นที่ตรวจสอบ: เขตหลักสี่ และจตุจักร';
            }
            
            // โหลด URL จาก localStorage ถ้ามี หรือใช้ค่าเริ่มต้น
            const savedSheetUrl = localStorage.getItem('groundwater_sheet_url') || 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSn30i6fduRSszPNUwWskmwK8-KKunVtFfqGAyyFBAzXWJx5C0uz_6iLhai-F2rdwFOxlGMNdEU2uT_/pub?output=csv';
            if (savedSheetUrl) {
                sheetUrlInput.value = savedSheetUrl;
                generatedData.setAttribute('data-sheet-url', savedSheetUrl);
            }
            
            // โหลด URL ชั้นดินจาก localStorage ถ้ามี หรือใช้ค่าเริ่มต้น
            const savedSoilSheetUrl = localStorage.getItem('groundwater_soil_sheet_url') || 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSn30i6fduRSszPNUwWskmwK8-KKunVtFfqGAyyFBAzXWJx5C0uz_6iLhai-F2rdwFOxlGMNdEU2uT_/pub?gid=1083314165&single=true&output=csv';
            if (savedSoilSheetUrl) {
                soilSheetUrlInput.value = savedSoilSheetUrl;
            }
            
            // บันทึก URL เมื่อกดปุ่มบันทึก
            document.getElementById('saveSheetUrl').addEventListener('click', function() {
                const url = sheetUrlInput.value.trim();
                if (url) {
                    localStorage.setItem('groundwater_sheet_url', url);
                    generatedData.setAttribute('data-sheet-url', url);
                    alert('บันทึก URL หลักเรียบร้อยแล้ว');
                    
                    // ตรวจสอบรหัสบ่อที่มีอยู่แล้วโดยอัตโนมัติ
                    checkExistingBoreholes();
                } else {
                    alert('กรุณาใส่ URL ของ Google Sheet CSV หลัก');
                }
            });
            
            // จัดการกับ URL ของ Google Sheet CSV ชั้นดิน
            const soilSheetUrlInput = document.getElementById('soilSheetUrl');
            
            // บันทึก URL ชั้นดินเมื่อกดปุ่มบันทึก
            document.getElementById('saveSoilSheetUrl').addEventListener('click', function() {
                const url = soilSheetUrlInput.value.trim();
                if (url) {
                    localStorage.setItem('groundwater_soil_sheet_url', url);
                    alert('บันทึก URL ชั้นดินเรียบร้อยแล้ว');
                } else {
                    alert('กรุณาใส่ URL ของ Google Sheet CSV ชั้นดิน');
                }
            });
            
            // ปุ่มล้างฟอร์ม
            document.getElementById('clearForm').addEventListener('click', function() {
                if (confirm('คุณต้องการล้างข้อมูลทั้งหมดในฟอร์มหรือไม่?')) {
                    // ล้างข้อมูลในฟอร์มที่แสดงอยู่
                    if (currentDataFormat === 'borehole') {
                        document.getElementById('groundwaterForm').reset();
                        // ตั้งค่าข้อมูลตัวอย่างใหม่
                        setTimeout(() => {
                            document.querySelector('input[name="latitude"]').value = '';
                            document.querySelector('input[name="longitude"]').value = '';
                            document.querySelector('input[name="totalDepth"]').value = '';
                            document.querySelector('input[name="waterLevel"]').value = '';
                            document.querySelector('input[name="soilName1"]').value = '';
                            document.querySelector('input[name="soilDepth1"]').value = '';
                            document.querySelector('input[name="soilDesc1"]').value = '';
                            document.querySelector('input[name="soilPH1"]').value = '';
                            boreholeNumber.value = '';
                            updateBoreholeId();
                        }, 100);
                    } else {
                        document.getElementById('locationForm').reset();
                        // ตั้งค่าข้อมูลตัวอย่างใหม่
                        setTimeout(() => {
                            document.querySelector('#taskName').value = '';
                            document.querySelector('#priority').value = 'P3';
                            document.querySelector('#owner').value = '';
                            document.querySelector('#taskStatus').value = 'ยังไม่เริ่ม';
                            document.querySelector('#startDate').value = '';
                            document.querySelector('#endDate').value = '';
                            document.querySelector('#reason').value = '';
                            document.querySelector('#notes').value = '';
                        }, 100);
                    }
                    
                    // ล้างข้อมูลที่สร้างแล้ว
                    document.getElementById('generatedData').value = '';
                    
                    alert('ล้างข้อมูลเรียบร้อยแล้ว พร้อมสำหรับใส่ข้อมูลใหม่');
                }
            });
            
            // ปุ่มตัวอย่างข้อมูลจริง
            const addExampleButtons = () => {
                // สำหรับฟอร์มบ่อบาดาล
                const boreholeForm = document.getElementById('groundwaterForm');
                if (boreholeForm && !document.getElementById('exampleBoreholeBtn')) {
                    const exampleBtn = document.createElement('button');
                    exampleBtn.type = 'button';
                    exampleBtn.id = 'exampleBoreholeBtn';
                    exampleBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded';
                    exampleBtn.textContent = 'ใส่ข้อมูลตัวอย่างจริง';
                    exampleBtn.onclick = fillBoreholeExample;
                    
                    const buttonContainer = boreholeForm.querySelector('.flex.justify-end.space-x-2');
                    buttonContainer.insertBefore(exampleBtn, buttonContainer.firstChild);
                }
                
                // สำหรับฟอร์มตารางงาน
                const locationForm = document.getElementById('locationForm');
                if (locationForm && !document.getElementById('exampleLocationBtn')) {
                    const exampleBtn = document.createElement('button');
                    exampleBtn.type = 'button';
                    exampleBtn.id = 'exampleLocationBtn';
                    exampleBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded';
                    exampleBtn.textContent = 'ใส่ข้อมูลตัวอย่างจริง';
                    exampleBtn.onclick = fillLocationExample;
                    
                    const buttonContainer = locationForm.querySelector('.flex.justify-end.space-x-2');
                    buttonContainer.insertBefore(exampleBtn, buttonContainer.firstChild);
                }
            };
            
            // ฟังก์ชันใส่ข้อมูลตัวอย่างบ่อบาดาล
            const fillBoreholeExample = () => {
                const today = new Date();
                const lat = (13.7563 + (Math.random() - 0.5) * 0.1).toFixed(6); // Random around Bangkok
                const lon = (100.5018 + (Math.random() - 0.5) * 0.1).toFixed(6);
                const year = today.getFullYear();
                const randomNum = Math.floor(Math.random() * 1000) + 1;
                
                document.querySelector('input[name="latitude"]').value = lat;
                document.querySelector('input[name="longitude"]').value = lon;
                boreholeNumber.value = `${year}-${randomNum.toString().padStart(3, '0')}`;
                updateBoreholeId();
                document.querySelector('input[name="totalDepth"]').value = Math.floor(Math.random() * 50) + 20; // 20-70m
                document.querySelector('input[name="waterLevel"]').value = Math.floor(Math.random() * 30) + 10; // 10-40m
                
                document.querySelector('input[name="soilName1"]').value = 'ดินร่วนปนทราย';
                document.querySelector('input[name="soilDepth1"]').value = '0-8 ม.';
                document.querySelector('input[name="soilDesc1"]').value = 'ดินสีน้ำตาลอ่อน มีการระบายน้ำดี';
                document.querySelector('input[name="soilColor1"]').value = '#D4A574';
                document.querySelector('input[name="soilColorPicker1"]').value = '#D4A574';
                document.querySelector('input[name="soilPH1"]').value = '6.8';
            };
            
            // ฟังก์ชันใส่ข้อมูลตัวอย่างตารางงาน
            const fillLocationExample = () => {
                const today = new Date();
                const nextMonth = new Date(today);
                nextMonth.setMonth(today.getMonth() + 1);
                
                const tasks = [
                    'ตรวจสอบคุณภาพน้ำบาดาลประจำเดือน',
                    'สำรวจแหล่งน้ำบาดาลใหม่',
                    'ติดตั้งระบบตรวจวัดน้ำบาดาล',
                    'วิเคราะห์ตัวอย่างน้ำจากบ่อบาดาล',
                    'ประเมินผลกระทบสิ่งแวดล้อม'
                ];
                
                const owners = ['ทีมวิจัยน้ำบาดาล', 'หน่วยตรวจสอบคุณภาพ', 'ทีมสำรวจพื้นที่', 'แผนกวิศวกรรม'];
                const priorities = ['P0', 'P1', 'P2', 'P3'];
                const statuses = ['ยังไม่เริ่ม', 'กำลังดำเนินการ', 'เสร็จสมบูรณ์'];
                
                const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
                const randomOwner = owners[Math.floor(Math.random() * owners.length)];
                const randomPriority = priorities[Math.floor(Math.random() * priorities.length)];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                
                document.querySelector('#taskName').value = randomTask;
                document.querySelector('#priority').value = randomPriority;
                document.querySelector('#owner').value = randomOwner;
                document.querySelector('#taskStatus').value = randomStatus;
                document.querySelector('#startDate').value = today.toISOString().split('T')[0];
                document.querySelector('#endDate').value = nextMonth.toISOString().split('T')[0];
                document.querySelector('#reason').value = 'เพื่อให้เป็นไปตามมาตรฐานการจัดการทรัพยากรน้ำบาดาล';
                document.querySelector('#notes').value = `พื้นที่ดำเนินการ: เขตกรุงเทพมหานคร - สร้างเมื่อ ${today.toLocaleDateString('th-TH')}`;
            };
            
            addExampleButtons();
            
            // เรียกฟังก์ชันเพิ่มปุ่มตัวอย่างเมื่อสลับรูปแบบ
            const originalToggleDataFormat = toggleDataFormat;
            toggleDataFormat = function(format) {
                originalToggleDataFormat(format);
                setTimeout(addExampleButtons, 100); // เพิ่ม delay เล็กน้อยเพื่อให้ DOM อัปเดต
            };
            
            // Show header banner
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:') {
                const banner = document.createElement('div');
                banner.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4';
                banner.innerHTML = `
                    <p class="font-bold">โหมดทดสอบ</p>
                    <p>นี่เป็นเพียงหน้าตัวอย่างสำหรับช่วยสร้างข้อมูล CSV เพื่อนำไปใส่ใน Google Sheet เท่านั้น</p>
                `;
                document.querySelector('header').after(banner);
            }
        });
    </script>
</body>
</html>
