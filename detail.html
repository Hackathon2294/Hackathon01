<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลของบ่อ - แผนที่น้ำบาดาล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom slider styles */
        .water-level-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--value), #e5e7eb var(--value), #e5e7eb 100%);
            outline: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .water-level-slider:hover {
            opacity: 1;
        }
        
        .water-level-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .water-level-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Soil layer visual styles */
        .soil-layer {
            position: relative;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .soil-layer:hover {
            border-color: #1f2937;
            transform: translateX(4px);
        }
        
        .depth-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Water level indicator */
        .water-level-line {
            position: absolute;
            right: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent 0%, #3b82f6 20%, #3b82f6 80%, transparent 100%);
            z-index: 10;
            transition: top 0.3s ease;
        }
        
        .water-level-label {
            position: absolute;
            right: 0;
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            transform: translateY(-50%);
            white-space: nowrap;
            z-index: 11;
            transition: top 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="flex items-center space-x-2 hover:bg-blue-700 px-3 py-2 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    <span>กลับ</span>
                </button>
                <h1 id="pageTitle" class="text-lg md:text-xl font-semibold">ข้อมูลของบ่อ</h1>
            </div>
            <button onclick="window.close()" class="hover:bg-blue-700 p-2 rounded">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 space-y-6">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-center">
            <p class="text-red-600">ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง</p>
            <button onclick="loadData()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                โหลดใหม่
            </button>
        </div>

        <!-- Content Container -->
        <div id="contentContainer" class="hidden space-y-6">
            <!-- Basic Info Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <h3 class="text-sm text-gray-500 mb-1">รหัสบ่อ</h3>
                        <p id="boreholeId" class="text-xl font-bold text-blue-600">#SRN-1027</p>
                    </div>
                    <div class="text-center">
                        <h3 class="text-sm text-gray-500 mb-1">ความลึกที่แสดง</h3>
                        <p id="totalDepth" class="text-xl font-bold text-gray-800">52 เมตร</p>
                    </div>
                    <div class="text-center">
                        <h3 class="text-sm text-gray-500 mb-1">ระดับน้ำบาดาล</h3>
                        <p id="currentWaterLevel" class="text-xl font-bold text-blue-500">32 เมตร</p>
                    </div>
                </div>
            </div>

            <!-- Water Level Control -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">ปรับระดับน้ำบาดาล</h2>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="text-sm font-medium text-gray-700 w-20">ระดับ:</label>
                        <input type="range" id="waterLevelSlider" class="flex-1 water-level-slider" 
                               min="0" max="52" value="32" step="0.1">
                        <span id="waterLevelValue" class="text-sm font-medium text-blue-600 w-16">32.0 ม.</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        <span>0 ม.</span>
                        <span class="float-right">52 ม.</span>
                    </div>
                </div>
            </div>

            <!-- Soil Diagram -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">แผนผังชั้นดิน</h2>
                <div class="relative border-2 border-blue-300 rounded-lg p-4 bg-gradient-to-b from-blue-50 to-blue-100" style="height: 400px;">
                    <!-- Water level indicator (will be positioned dynamically) -->
                    <div id="waterLevelIndicator" class="water-level-line"></div>
                    <div id="waterLevelLabel" class="water-level-label">ระดับน้ำบาดาล 32.0m</div>
                    
                    <!-- Soil layers container -->
                    <div id="soilLayersContainer" class="relative h-full">
                        <!-- Soil layers will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Information Boxes -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Soil Details Box -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">รายละเอียดชั้นดิน</h2>
                    <div id="soilDetailsContainer" class="space-y-3">
                        <!-- Soil details will be dynamically inserted here -->
                    </div>
                </div>

                <!-- pH Values Box -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">ค่า pH</h2>
                    <div id="phValuesContainer" class="space-y-3">
                        <!-- pH values will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Sample data structure - will be replaced with data from Google Sheet
        let boreholeData = {
            id: 'SRN-1027',
            totalDepth: 52,
            waterLevel: 32,
            soilLayers: [
                {
                    name: 'ดินเหนียว',
                    depthRange: '0-8 ม.',
                    startDepth: 0,
                    endDepth: 8,
                    color: '#B45F35', // สีแดงอิฐ
                    description: 'ดินเหนียวสีน้ำตาลแดง',
                    ph: '6.8'
                },
                {
                    name: 'ดินเหนียวปนทราย',
                    depthRange: '8-20 ม.',
                    startDepth: 8,
                    endDepth: 20,
                    color: '#D2691E', // สีน้ำตาล
                    description: 'ดินเหนียวปนทรายสีน้ำตาล',
                    ph: '7.1'
                },
                {
                    name: 'หินดินดาน',
                    depthRange: '20-40 ม.',
                    startDepth: 20,
                    endDepth: 40,
                    color: '#708090', // สีเทา
                    description: 'หินดินดานสีเทา',
                    ph: '7.5'
                },
                {
                    name: 'ทรายฝน',
                    depthRange: '40-52 ม.',
                    startDepth: 40,
                    endDepth: 52,
                    color: '#C0C0C0', // สีเทาอ่อน
                    description: 'ทรายฝนละเอียด (สีเทาอ่อน)',
                    ph: '8.2'
                }
            ]
        };

        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Load data based on URL parameters or from Google Sheet
        async function loadData() {
            try {
                const boreholeId = getUrlParameter('id');
                const totalDepth = getUrlParameter('totalDepth');
                const waterLevel = getUrlParameter('waterLevel');
                const soilLayersParam = getUrlParameter('soilLayers');
                
                if (boreholeId) {
                    // Use data from URL parameters if available
                    if (totalDepth && waterLevel) {
                        boreholeData.id = boreholeId;
                        boreholeData.totalDepth = parseFloat(totalDepth) || 52;
                        boreholeData.waterLevel = parseFloat(waterLevel) || 32;
                        
                        // Parse soil layers if available
                        if (soilLayersParam) {
                            try {
                                const soilLayers = JSON.parse(decodeURIComponent(soilLayersParam));
                                if (Array.isArray(soilLayers) && soilLayers.length > 0) {
                                    // Convert to the format expected by detail.html
                                    boreholeData.soilLayers = soilLayers.map((layer, index) => {
                                        // Parse depth range from string like "0-8 ม." or "8-20"
                                        const depthParts = layer.depth.replace(/[ม\.]/g, '').split('-');
                                        const startDepth = parseFloat(depthParts[0]) || (index * 10);
                                        const endDepth = parseFloat(depthParts[1]) || (startDepth + 10);
                                        
                                        return {
                                            name: layer.name || `ชั้นที่ ${index + 1}`,
                                            depthRange: layer.depth || `${startDepth}-${endDepth} ม.`,
                                            startDepth: startDepth,
                                            endDepth: endDepth,
                                            color: layer.color || '#CCCCCC',
                                            description: layer.desc || 'ไม่มีรายละเอียด',
                                            ph: layer.ph || ''
                                        };
                                    });
                                }
                            } catch (e) {
                                console.error('Error parsing soil layers:', e);
                            }
                        }
                    } else {
                        // Try to fetch data from Google Sheet
                        await fetchDataFromSheet(boreholeId);
                    }
                } else {
                    // Use sample data
                    console.log('Using sample data');
                }
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('contentContainer').classList.remove('hidden');
                
                // Initialize the display
                initializeDisplay();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }
        }

        // Fetch data from Google Sheet (placeholder for future implementation)
        async function fetchDataFromSheet(boreholeId) {
            // This would fetch actual data from Google Sheet
            // For now, we'll use the sample data
            console.log('Fetching data for borehole:', boreholeId);
            
            // Update sample data with the requested ID
            boreholeData.id = boreholeId;
        }

        // Initialize the display with data
        function initializeDisplay() {
            // Update basic info
            document.getElementById('pageTitle').textContent = `ข้อมูลของบ่อ #${boreholeData.id}`;
            document.getElementById('boreholeId').textContent = `#${boreholeData.id}`;
            document.getElementById('totalDepth').textContent = `${boreholeData.totalDepth} เมตร`;
            document.getElementById('currentWaterLevel').textContent = `${boreholeData.waterLevel} เมตร`;

            // Setup water level slider
            const slider = document.getElementById('waterLevelSlider');
            slider.max = boreholeData.totalDepth;
            slider.value = boreholeData.waterLevel;
            updateWaterLevelDisplay(boreholeData.waterLevel);

            // Render soil layers
            renderSoilLayers();
            renderSoilDetails();
            renderPhValues();

            // Setup slider event listener
            slider.addEventListener('input', function() {
                const newLevel = parseFloat(this.value);
                updateWaterLevelDisplay(newLevel);
            });
        }

        // Update water level display
        function updateWaterLevelDisplay(level) {
            document.getElementById('waterLevelValue').textContent = `${level.toFixed(1)} ม.`;
            document.getElementById('currentWaterLevel').textContent = `${level.toFixed(1)} เมตร`;
            document.getElementById('waterLevelLabel').textContent = `ระดับน้ำบาดาล ${level.toFixed(1)}m`;

            // Update slider background
            const slider = document.getElementById('waterLevelSlider');
            const percentage = (level / boreholeData.totalDepth) * 100;
            slider.style.setProperty('--value', percentage + '%');

            // Update water level indicator position
            updateWaterLevelIndicator(level);
        }

        // Update water level indicator position in soil diagram
        function updateWaterLevelIndicator(level) {
            const percentage = (level / boreholeData.totalDepth) * 100;
            const indicator = document.getElementById('waterLevelIndicator');
            const label = document.getElementById('waterLevelLabel');
            
            indicator.style.top = percentage + '%';
            label.style.top = percentage + '%';
        }

        // Render soil layers in the diagram
        function renderSoilLayers() {
            const container = document.getElementById('soilLayersContainer');
            container.innerHTML = '';

            boreholeData.soilLayers.forEach((layer, index) => {
                const layerHeight = ((layer.endDepth - layer.startDepth) / boreholeData.totalDepth) * 100;
                const layerTop = (layer.startDepth / boreholeData.totalDepth) * 100;

                const layerElement = document.createElement('div');
                layerElement.className = 'soil-layer absolute w-full';
                layerElement.style.cssText = `
                    top: ${layerTop}%;
                    height: ${layerHeight}%;
                    background-color: ${layer.color};
                    color: ${getTextColor(layer.color)};
                `;

                layerElement.innerHTML = `
                    <div class="p-3 h-full flex flex-col justify-center">
                        <div class="font-medium text-sm">${layer.name}</div>
                        <div class="text-xs opacity-90">${layer.depthRange}</div>
                    </div>
                    <div class="depth-indicator">${Math.round(layerHeight)}%</div>
                `;

                container.appendChild(layerElement);
            });
        }

        // Render soil details in the info box
        function renderSoilDetails() {
            const container = document.getElementById('soilDetailsContainer');
            container.innerHTML = '';

            boreholeData.soilLayers.forEach(layer => {
                const detailElement = document.createElement('div');
                detailElement.className = 'flex items-start space-x-3 p-3 bg-gray-50 rounded-lg';
                detailElement.innerHTML = `
                    <div class="w-4 h-4 rounded-full mt-0.5 flex-shrink-0" style="background-color: ${layer.color};"></div>
                    <div class="flex-1">
                        <div class="font-medium text-sm">${layer.name} (${layer.depthRange})</div>
                        <div class="text-xs text-gray-600 mt-1">${layer.description}</div>
                    </div>
                `;
                container.appendChild(detailElement);
            });
        }

        // Render pH values in the info box
        function renderPhValues() {
            const container = document.getElementById('phValuesContainer');
            container.innerHTML = '';

            boreholeData.soilLayers.forEach(layer => {
                if (layer.ph) {
                    const phElement = document.createElement('div');
                    phElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    phElement.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${layer.color};"></div>
                            <span class="font-medium text-sm">${layer.name} (${layer.depthRange})</span>
                        </div>
                        <span class="text-lg font-bold text-blue-600">pH ${layer.ph}</span>
                    `;
                    container.appendChild(phElement);
                }
            });
        }

        // Helper function to determine text color based on background
        function getTextColor(backgroundColor) {
            // Convert hex to RGB
            const r = parseInt(backgroundColor.slice(1, 3), 16);
            const g = parseInt(backgroundColor.slice(3, 5), 16);
            const b = parseInt(backgroundColor.slice(5, 7), 16);
            
            // Calculate brightness
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            return brightness > 128 ? '#000000' : '#FFFFFF';
        }

        // Go back function
        function goBack() {
            // Always go back to index.html
            window.location.href = 'index.html';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>
